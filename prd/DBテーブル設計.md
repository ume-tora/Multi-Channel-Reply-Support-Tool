# DBテーブル設計書: Multi Channel Reply Support Tool

## 1. データ保存方針
本プロジェクトでは、サーバーサイドのデータベースは使用しない。
ユーザー設定やAPIキーなどの永続化が必要なデータは、Chrome Extension APIが提供する `chrome.storage.local` を利用して、ユーザーのブラウザ内に安全に保存する。

### `chrome.storage.local` を選定する理由
- **データ容量:** `chrome.storage.sync` (約100KB) よりも大容量 (約5MB) のため、会話履歴のキャッシュなど将来的なデータ量の増加に対応しやすい。
- **同期不要:** APIキーのような、ユーザーのGoogleアカウントで同期する必要のない機密情報の保存に適している。

## 2. データ構造定義
`chrome.storage.local` はキーバリュー形式のストアである。以下に保存するデータのキーと、その値の構造を定義する。

### 2.1. `settings` (設定情報)
ユーザー固有の設定情報を格納する。

| キー名 | 値の型 | 説明 |
| :--- | :--- | :--- |
| **`apiKey`** | `string` | ユーザーが設定したGemini APIのキー。保存する際は、簡易的な難読化や暗号化を検討することが望ましい。 |
| **`userSettings`**| `Object` | 返信のトーンや署名など、将来的なユーザー設定項目を格納するためのオブジェクト。PoC段階では未使用でも、拡張性のために定義しておく。 |

**`userSettings` の構造例:**

    {
      "defaultTone": "polite",
      "signature": "--\nJohn Doe"
    }

### 2.2. `cache` (会話履歴キャッシュ)
APIのコール回数を削減し、応答速度を向上させるため、一度取得した会話のコンテキストを一時的にキャッシュする。評価観点である「キャッシュ戦略」の根幹となる設計。

| キーの命名規則 | 値の型 | 説明 |
| :--- | :--- | :--- |
| **`cache_[channel]_[threadId]`** | `Object`| どのチャネルの、どの会話スレッドに対するキャッシュかを一意に識別するための動的なキー。例: `cache_gmail_thread12345` |

**キャッシュオブジェクト (`value`) の構造:**

    interface CacheObject {
      // 会話の履歴（ユーザーとモデルの発言）
      messages: Array<{
        role: 'user' | 'model';
        content: string;
      }>;
      
      // キャッシュの有効期限（Unixタイムスタンプ）
      expiresAt: number; 
    }

### 2.3. キャッシュ戦略補足
- **有効期限 (TTL):** キャッシュデータには有効期限（例: 1時間）を設け、`expiresAt` を超えたデータは古いものとみなし、再度APIから取得する。
- **データ削除:** 定期的に、またはストレージ容量が逼迫した場合に、有効期限切れのキャッシュをクリーンアップする処理を`background`スクリプトで実行することを検討する。